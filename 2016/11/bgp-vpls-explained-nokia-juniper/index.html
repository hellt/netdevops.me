<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>BGP VPLS deep dive. Nokia SR OS & Juniper |</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content><meta name=twitter:title content="BGP VPLS deep dive. Nokia SR OS & Juniper"><meta name=twitter:description content><meta name=twitter:creator content="@ntdvps"><meta name=Description content="DevOps applied to networking"><meta property="og:title" content="BGP VPLS deep dive. Nokia SR OS & Juniper"><meta property="og:description" content="It may very well be that VPLS days are numbered and EVPN is to blame. Nevertheless, it would be naive to expect VPLS extinction in the near future. With all its shortcomings VPLS is still very well standardized, interop-proven and has a huge footprint in MPLS networks of various scale.
In this post I will cover theory and configuration parts for one particular flavor of VPLS signalling - BGP VPLS (aka Kompella VPLS) defined in RFC4761. I&rsquo;ll start with simple single home VPLS scenario while multi-homing techniques and some advanced configurations might appear in a separate post later.
In this topic the following SW releases were used:

Nokia (Alcatel-Lucent) VSR 14.0.R4
Juniper vMX 14.1R1.10
"><meta property="og:type" content="article"><meta property="og:url" content="https://netdevops.me/2016/11/bgp-vpls-explained-nokia-juniper/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-11-14T04:22:27+00:00"><meta property="article:modified_time" content="2021-04-19T12:35:46+02:00"><meta name=application-name content="NetDevOps"><meta name=apple-mobile-web-app-title content="NetDevOps"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=192x192 href=/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=/android-chrome-512x512.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://netdevops.me/2016/11/bgp-vpls-explained-nokia-juniper/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"BGP VPLS deep dive. Nokia SR OS \u0026 Juniper","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/netdevops.me\/2016\/11\/bgp-vpls-explained-nokia-juniper\/"},"genre":"posts","keywords":"bgp, vpls, nokia, juniper","wordCount":4997,"url":"https:\/\/netdevops.me\/2016\/11\/bgp-vpls-explained-nokia-juniper\/","datePublished":"2016-11-14T04:22:27+00:00","dateModified":"2021-04-19T12:35:46+02:00","description":""}</script></head><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header><div class="desktop header" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=NetDevOps class="header-logo logo-svg">NetDevOps</a></div><div class=menu><nav><h2 class=display-hidden>Основная навигация</h2><ul class=menu-inner><li><a class=menu-item href=/posts/>Posts</a></li><li><a class=menu-item href=/tags/>Tags</a></li></ul></nav><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=Search... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><span class="svg-icon icon-search"></span></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><span class="svg-icon icon-cancel"></span></a><span class="search-button search-loading" id=search-loading-desktop><span class="svg-icon icon-loading"></span></span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></div><div class="mobile header" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=NetDevOps class=header-logo>NetDevOps</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=Search... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><span class="svg-icon icon-search"></span></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><span class="svg-icon icon-cancel"></span></a><span class="search-button search-loading" id=search-loading-mobile><span class="svg-icon icon-loading"></span></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><nav><h2 class=display-hidden>Основная навигация</h2><ul><li><a class=menu-item href=/posts/ title>Posts</a></li><li><a class=menu-item href=/tags/ title>Tags</a></li></ul></nav><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></div><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div></header><main class=main><div class="container content-article theme-classic"><div class=toc id=toc-auto><div class=toc-title>Contents</div><div class="toc-content always-active" id=toc-content-auto></div></div><article><header class=header-post><div class=post-title><div class=post-all-meta><nav class=breadcrumbs><ol><li><a href=/>Home</a></li><li>BGP VPLS deep dive. Nokia SR OS & Juniper</li></ol></nav><h1 class="single-title flipInX">BGP VPLS deep dive. Nokia SR OS & Juniper</h1><div class="post-meta summary-post-meta"><span class="post-meta-date meta-item"><span class="svg-icon icon-clock"></span><time class=timeago datetime=2016-11-14>2016-11-14</time>
</span><span class="post-meta-words meta-item"><span class="svg-icon icon-pencil"></span>4997 words</span>
<span class="post-meta-reading meta-item"><span class="svg-icon icon-stopwatch"></span>24 minutes</span></div></div></div></header><div class="article-post toc-start"><div class="content-block content-block-first content-block-position"><div class="post single"><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#bgp-vpls-basics>BGP VPLS Basics</a></li><li><a href=#vpls-data-plane>VPLS data plane</a></li><li><a href=#case-study-single-homed-vpls>Case study: Single-homed VPLS</a></li><li><a href=#references--further-reading>References & further reading</a></li></ul></li></ul></nav></div></div><div style="margin:20px 0"><span class=post-update><span class=s>Updated on 2021-04-19</span></span></div><p>It may very well be that VPLS days are numbered and EVPN is to blame. Nevertheless, it would be naive to expect VPLS extinction in the near future. With all its shortcomings VPLS is still very well standardized, interop-proven and has a huge footprint in MPLS networks of various scale.</p><p>In this post I will cover theory and configuration parts for one particular flavor of VPLS signalling - BGP VPLS (aka Kompella VPLS) defined in <a href=http://www.rfcreader.com/#rfc4761 target=_blank rel="noopener noreffer">RFC4761</a>. I&rsquo;ll start with simple single home VPLS scenario while multi-homing techniques and some advanced configurations might appear in a separate post later.</p><p>In this topic the following SW releases were used:</p><ul><li>Nokia (Alcatel-Lucent) VSR 14.0.R4</li><li>Juniper vMX 14.1R1.10</li></ul><h3 id=bgp-vpls-basics class=headerLink><a href=#bgp-vpls-basics class=header-mark></a>BGP VPLS Basics</h3><p>Virtual Private LAN Service (VPLS) is seen like an Ethernet LAN by the customers of a Service Provider. However, in a VPLS, not all of the customers are connected to a single LAN; they may be spread across a metro or wide area network. In essence, a VPLS glues together several individual LANs across a packet switched network to appear and function as a single LAN. This is accomplished by incorporating MAC address learning, flooding, and forwarding functions in the context of pseudowires that connect these individual LANs.</p><p>The entire VPLS service behaves like a big switch with distributed MAC learning intelligence implemented on each PE, and as in a switch, MAC learning happens in a dataplane.</p><div align=center><img src=https://img-fotki.yandex.ru/get/194989/21639405.11c/0_8b216_eacf5704_XL.png></div><p>The following two types of interfaces are typical for VPLS:</p><ol><li>Attachment Circuits (AC) - circuits connecting Customer Edge (CE) devices to Provider Edge (PE) routers. PE routers often called VPLS Edge (VE) devices in VPLS terminology.</li><li>Pseudowires (PW) - circuits connecting PEs between each other</li></ol><p>In the context of a given VPLS instance, a PE can have one or more local ACs, and one or more PWs toward remote PEs. Full-mesh of transport tunnels between PEs is required.</p><p>In Kompella VPLS, BGP is a key enabler and is responsible for:</p><ul><li><strong>Auto-discovery</strong>: process of finding all PE routers participating in a VPLS instance;</li><li><strong>Signalling</strong>: the setup and tear-down of pseudowires (PW) that constitute the VPLS service.</li></ul><h4 id=auto-discovery class=headerLink><a href=#auto-discovery class=header-mark></a>Auto-discovery</h4><p>Each PE &ldquo;discovers&rdquo; which other PEs are part of a given VPLS by means of BGP. This allows each PE&rsquo;s configuration to consist only of the identity of the VPLS instance established on this PE, not the identity of every other PE in that VPLS instance. Moreover, when the topology of a VPLS changes, only the affected PE&rsquo;s configuration changes; other PEs automatically find out about the change and adapt.</p><blockquote><p>The Route Target community is used to identify members of a VPLS. A PE announces that it belongs to <code>VPLS V</code> by annotating its NLRIs for <code>VPLS V</code> with Route Target <code>RT</code>, and acts on this by accepting NLRIs from other PEs that have Route Target <code>RT</code>. A PE announces that it no longer participates in <code>VPLS V</code> by withdrawing all NLRIs that it had advertised with Route Target <code>RT</code>.</p></blockquote><h4 id=signalling class=headerLink><a href=#signalling class=header-mark></a>Signalling</h4><p>Once discovery is done, each pair of PEs in a VPLS must be able to establish (and tear down) pseudowires to each other, i.e., exchange (and withdraw) <em>demultiplexors</em>. This process is known as signaling. Signaling is also used to transmit certain characteristics of the pseudowires that a PE sets up for a given VPLS.</p><p>BGP Update message carrying BGP VPLS NLRI (AFI:25, SAFI:65) is used to signal VPLS membership and multiplexors for a VPLS service:</p><img src=http://img-fotki.yandex.ru/get/194989/21639405.11c/0_8b217_8630d094_XL.png><p>Let&rsquo;s expand some of the fields of the BGP VPLS NLRI:</p><ul><li><strong>Route Distinguisher</strong> - used to differentiate between customer NLRIs thus should be unique for every VPLS service.</li><li><strong>VE ID</strong> - unique identifier (aka site-id), manually assigned to every VPLS Edge device.</li><li><strong>VE Block Offset, VE Block Size and Label Base</strong> are used for calculating the service label (multiplexor).</li></ul><h4 id=label-blocks class=headerLink><a href=#label-blocks class=header-mark></a>Label Blocks</h4><p>Using a distinct BGP Update message to send a demultiplexor to each remote PE would require the originating PE to send N such messages for N remote PEs. In order to minimize the control plane load original standard introduced <code>Label Blocks</code> which drastically reduce the amount of BGP Update messages. A label block is a set of demultiplexor labels used to reach a given VE ID.</p><p>A single BGP VPLS NLRI signals a label block which consists of:</p><ul><li><strong>VE ID</strong> - manually assigned to VE device identifier</li><li><strong>Label Base (LB)</strong> - first label assigned to a label block</li><li><strong>VE Block Size (VBS)</strong> - number of labels assigned to a label block. Vendor-dependant value, Nokia and Juniper both use Block Size of 8.</li><li><strong>VE Block Offset (VBO)</strong> - first VE ID assigned to a label block</li></ul><p>A contiguous label block defined by <code>&lt;LB, VBO, VBS></code> is the set <code>{LB+VBO, LB+VBO+1, ..., LB+VBO+VBS-1}</code>. Thus, instead of a single large label block to cover all VE IDs in a VPLS, one can have several label blocks, each with a different label base.</p><div align=center><img src=http://img-fotki.yandex.ru/get/194989/21639405.11c/0_8b218_ad2446d0_XL.png alt width=622 height=800></div><h4 id=pseudowire-setup-process class=headerLink><a href=#pseudowire-setup-process class=header-mark></a>Pseudowire setup process</h4><p><a href=http://www.rfcreader.com/#rfc4761_line427 target=_blank rel="noopener noreffer">Section 3.2.3</a> of RFC4761 highlights the steps VE routers go through during PW setup/teardown. Lets see by an example how PW setup takes places in a BGP VPLS between routers VE1 and VE7.</p><div align=center><a href=http://img-fotki.yandex.ru/get/172931/21639405.11c/0_8b219_25de426c_orig.png><img src=http://img-fotki.yandex.ru/get/172931/21639405.11c/0_8b219_25de426c_XL.png alt width=543 height=800></a></div><ol><li><p>Router VE1 is part of VPLS <code>BLUE</code> and has VPLS service configured with the following parameters:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>VE ID: 1
RT: 65000:10
RD: 1.1.1.1:10
</code></pre></td></tr></table></div></div><p>Upon a service config router VE1 sends BGP Update message to all its BGP peers with NLRI describing its label block. Since for this moment VE1 has no knowledge about any other router participating in <code>VPLS BLUE</code> service it sends only one NLRI. This NLRI covers a label block which has its own VE-ID (refer to the figure 40)</p></li><li><p>When VE10 router boots with the same <code>VPLS BLUE</code> service configured using the following params:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>VE ID: 10
RT: 65000:10
RD: 10.10.10.10:10
</code></pre></td></tr></table></div></div><p>it sends BGP Update to all its peers. Again, since VE10 hasn&rsquo;t seen any VE routers yet, it will send only one NLRI with a label block which its VE-ID reside in.</p></li><li><p>VE1 receive BGP Update send by VE10 and since route-target community is the same on both routers VE1 accepts it. Then VE1 performs a check whether the NLRI it received from VE10 can be used for PW setup (see Fig. 50, step 3). Since the result of the check returned false, VE1 can&rsquo;t use received NLRI from VE10 for PW setup towards it.</p><div align=center><a href=http://img-fotki.yandex.ru/get/172684/21639405.11c/0_8b21a_2dba3df9_orig.png><img src=http://img-fotki.yandex.ru/get/172684/21639405.11c/0_8b21a_2dba3df9_XL.png alt width=475 height=800></a></div></li><li><p>By receiving an update from VE10, VE1 now has knowledge of VE10 existence and checks if it has sent label block which contains a label for VE10. As stated in Fig. 40, VE1 sent label block containing information that can be used by routers with VE-ID from 1 to 8, thus VE10 can not setup PW using this label block.
VE1 then sends another BGP Update with NLRI covering VE-IDs from 9 to 16 to satisfy VE10 needs.</p></li><li><p>Router VE10 performs the same check against received NLRI. This time the check is passed and VE10 can calculate a label (multiplexor) which it should use for PW from VE10 to VE1.</p></li><li><p>As in step 4, VE10 generates additional BGP Update with NLRI covering VE1 range.</p></li></ol><p>This enables PW to setup from VE1 to V10 and from VE10 to VE1 by using MPLS labels calculated on each router independently.</p><h4 id=layer-2-info-extended-community class=headerLink><a href=#layer-2-info-extended-community class=header-mark></a>Layer 2 Info Extended community</h4><p>Additional extended community is used in VPLS service establishment - originally <code>Layer 2 Info</code> extended community was defined in section <a href=http://www.rfcreader.com/#rfc4761_line453 target=_blank rel="noopener noreffer">3.2.4</a>. It is used to signal control information about the pseudowires to be setup for a given VPLS. Two additional bits (D, F) later were introduced by <a href=https://tools.ietf.org/html/draft-ietf-bess-vpls-multihoming-01#section-3.3.1 target=_blank rel="noopener noreffer">vpls-multihoming draft</a>.</p><div align=center><a href=http://img-fotki.yandex.ru/get/195853/21639405.11c/0_8b21b_9f734cbc_orig.png><img src=http://img-fotki.yandex.ru/get/195853/21639405.11c/0_8b21b_9f734cbc_XL.png alt width=800 height=605></a></div><h5 id=mtu-considerations class=headerLink><a href=#mtu-considerations class=header-mark></a>MTU considerations</h5><p>One of the important fields in L2 Info community is the <code>Layer 2 MTU</code>. VE routers signal MTU which can be carried within VPLS service, moreover some router platforms will bring service into down state if the MTU values mismatch. Usually you can find configuration knobs which will turn off <code>MTU matching</code>, though it is better to keep MTU consistent between endpoints.</p><p>Interesting fact is that Juniper routers (at least vMX 14.1) defaults to signal <code>MTU=0</code> (as seen in Figure 80), which wont bring service down, because this means <strong>do not consider MTU value</strong>. Again, in vMX 14.1 there is no way to signal any particular MTU value for VPLS service, though starting with 15.1 it is possible with <code>mtu</code> keyword.</p><h4 id=vlan-tag-multiplexing class=headerLink><a href=#vlan-tag-multiplexing class=header-mark></a>VLAN tag multiplexing</h4><p>To understand how ethernet frames are handled by PE and transported over PW we need to cover possible variations of frames on AC, as well as different modes of PW operation.</p><p>Frames from the CE devices can be seen on the attachment circuits in different flavours:</p><ul><li>untagged</li><li>tagged (dot1q, q-in-q) by CE device itself</li><li>additionally tagged by some SP&rsquo;s aggregation device (SVLAN put by L2 agg. device)</li></ul><p>When it comes to PW operation modes, <a href=http://www.rfcreader.com/#rfc4448_line274 target=_blank rel="noopener noreffer">RFC 4448</a> gives us two options: <strong>raw</strong> and <strong>tagged</strong>. Thus, we can distinguish two cases regarding tagged frames coming from AC:</p><ul><li><p><strong>The tag is service-delimiting.</strong><br>This means that the tag was placed on the frame by some piece of service provider-operated equipment, and the tag is used by the service provider to distinguish the traffic. For example, LANs from different customers might be attached to the same service provider switch, which applies VLAN tags to distinguish one customer&rsquo;s traffic from another&rsquo;s, and then forwards the frames to the PE.</p></li><li><p><strong>The tag is not service-delimiting.</strong><br>This means that the tag was placed in the frame by a piece of customer equipment, and is not meaningful to the PE.</p></li></ul><p>RFC 4448 explains further possible scenarios actions:</p><ul><li>PW is operating in <strong>raw mode (aka Ether)</strong>:<ul><li>Service-delimiting tags are NEVER sent over the PW, if tag is present, it MUST be stripped before sending on PW</li><li>When sending a frame on AC, PE may add service-delimiting tag, but <strong>can not</strong> strip or rewrite any existing tags present on a frame</li></ul></li><li>PW is operating in <strong>tagged</strong> <strong>mode (aka VLAN)</strong>:<ul><li>PW MUST have a service-delimiting VLAN tag. If service-delimiting tag is not present, the PE must prepend the frame with a dummy VLAN tag before sending the frame on the PW</li><li>When sending a frame on AC, PE may rewrite or strip tag entirely</li></ul></li><li>Whether or not the tag is service-delimiting is determined by local configuration on the PE</li><li>Service-delimiting tag have local to PE-CE interface significance</li><li>Non-service-delimiting tags are passed transparently across the PW as part of the payload</li></ul><h3 id=vpls-data-plane class=headerLink><a href=#vpls-data-plane class=header-mark></a>VPLS data plane</h3><p>This topic is focusing on VPLS data plane encapsulation, as defined in <a href=http://www.rfcreader.com/#rfc4448 target=_blank rel="noopener noreffer">RFC 4448</a> - Encapsulation Methods for Transport of Ethernet over MPLS Networks.</p><h4 id=mac-learning class=headerLink><a href=#mac-learning class=header-mark></a>MAC learning</h4><p>VPLS is a multipoint service with a MAC learning on a data plane. This means that the entire Service Provider network should appear as a single logical learning bridge (Ethernet switch) for each VPLS that the SP network supports. The logical ports for the SP &ldquo;bridge&rdquo; are the AC as well as the PW on a PE. As a result of MAC learning, bridges populate a MAC table in which they keep track of the interface (or PW) where each unicast MAC is reachable.</p><h4 id=aging-flooding-bum-traffic class=headerLink><a href=#aging-flooding-bum-traffic class=header-mark></a>Aging, Flooding, BUM traffic</h4><p>VPLS PEs SHOULD have an aging mechanism to remove a MAC address associated with a logical port. Aging reduces the size of a VPLS MAC table to just the active MAC addresses. When a bridge receives a packet to a destination that is not in its FIB, it floods the packet on all the other ports (process known as replication). Frames that should be flooded are Broadcast, Unknown unicast and Multicast</p><ul><li>Broadcast frames have destination MAC address <code>ff:ff:ff:ff:ff:ff</code>.</li><li>Multicast frames have a destination MAC address whose first octet has its last bit set to one</li></ul><p>To avoid loops during replication process split-horizon rule should be honored: A frame received on a PW is never sent back on the same or any other PW (default, but configurable behavior).</p><h3 id=case-study-single-homed-vpls class=headerLink><a href=#case-study-single-homed-vpls class=header-mark></a>Case study: Single-homed VPLS</h3><p>Enough with theory, time to practice some VPLS! I will start with a simple case of two CE routers (CE1 and CE2) connected to a Service Provider&rsquo;s PE routers (R1, R2) configured with a VPLS service.
Refer to Fig. 60 outlining lab topology for this case. It is assumed that ISIS and LDP are configured and operational.</p><div align=center><a href=http://img-fotki.yandex.ru/get/194989/21639405.11d/0_8b222_20c181b9_orig.png><img src=http://img-fotki.yandex.ru/get/194989/21639405.11d/0_8b222_20c181b9_XL.png alt width=800 height=658></a></div><p>Refer to these baseline configurations:</p><ul><li><a href=https://gist.github.com/hellt/f9adc0cf6aba73eb7cc9f232c5243008 target=_blank rel="noopener noreffer">R1 (Nokia)</a></li><li><a href=https://gist.github.com/hellt/1536d41be077390915d46178b72b1179 target=_blank rel="noopener noreffer">R2 (Juniper)</a></li><li><a href=https://gist.github.com/hellt/a525df301d56c7065ec9ed2b5bd74f0c target=_blank rel="noopener noreffer">R3 Route reflector (Nokia)</a></li></ul><h4 id=bgp-configuration class=headerLink><a href=#bgp-configuration class=header-mark></a>BGP configuration</h4><p>This one is really simple. All we need is to configure MP-iBGP peering between PEs and RR with <strong>L2 VPN family</strong> enabled:</p><p><strong>R1 (Nokia)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>*A:R1&gt;config&gt;router# info
#--------------------------------------------------
echo &#34;IP Configuration&#34;
#--------------------------------------------------
## &lt; Output omitted for brevity &gt;

        autonomous-system 65000
#--------------------------------------------------


*A:R1&gt;config&gt;router&gt;bgp# info
----------------------------------------------
            connect-retry 1
            min-route-advertisement 1
            rapid-withdrawal
            rapid-update l2-vpn
            group &#34;RR&#34;
                family l2-vpn
                enable-peer-tracking
                neighbor 3.3.3.3
                    type internal
                exit
            exit
            no shutdown
----------------------------------------------
</code></pre></td></tr></table></div></div><p><strong>R3 Route reflector (Nokia)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>*A:R3&gt;config&gt;router# info
#--------------------------------------------------
echo &#34;IP Configuration&#34;
#--------------------------------------------------
## &lt; Output omitted for brevity &gt;

        autonomous-system 65000
#--------------------------------------------------


A:R3&gt;config&gt;router&gt;bgp# info
----------------------------------------------
            family l2-vpn
            connect-retry 1
            min-route-advertisement 1
            enable-peer-tracking
            rapid-withdrawal
            rapid-update l2-vpn
            group &#34;RRC&#34;
                cluster 3.3.3.3
                neighbor 1.1.1.1
                    type internal
                exit
                neighbor 2.2.2.2
                    type internal
                exit
            exit
            no shutdown
----------------------------------------------
</code></pre></td></tr></table></div></div><p><strong>R2 (Juniper)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>root@R2# show routing-options | grep auto
autonomous-system 65000;

root@R2# show protocols bgp
group RR {
    type internal;
    family l2vpn {
        signaling;
    }
    neighbor 3.3.3.3;
}
</code></pre></td></tr></table></div></div><h4 id=interface-configuration class=headerLink><a href=#interface-configuration class=header-mark></a>Interface configuration</h4><p>To demonstrate vlan-normalization methods I used two different vlans on attachment circuits connected to R1 and R2. Our CE1 and CE2 devices have simple dot1q interfaces addressed in this way:</p><ul><li>CE1 has interface <code>toCE2</code> with address <code>192.168.1.1/24</code>, <code>VLAN 10</code></li><li>CE1 has interface <code>toCE1</code> with address <code>192.168.1.2/24</code>, <code>VLAN 600</code></li></ul><p>Router R1 has vlan 10 on its AC, while R2 configured with vlan-id 600 (on Juniper vlan ids values for VPLS interfaces must be > 512).</p><p>Nokia routers do not differ if interface is going to be used in any particular service or in no service at all, therefore the configuration steps are obvious. The part which enables particular ethernet encapsulation (802.1q in this case) is done under port configuration:</p><p><strong>R1:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>A:R1# configure port 1/1/2
A:R1&gt;config&gt;port# info
----------------------------------------------
        ethernet
            mode hybrid  ## hybrid means that port can act as an access &amp; network port
            encap-type dot1q
        exit
        no shutdown
----------------------------------------------
</code></pre></td></tr></table></div></div><p>Configuration of <code>Vlan-id 10</code> attachment to a VPLS service will be done later in the VPLS configuration section.</p><p>Note, that Ethernet MTU on Nokia routers includes Ethernet header. This means that, for instance, interface with MTU 2000 will be able to put on wire exactly 2000 bytes, for example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>TOTAL 2000B == Frame 54: 2000 bytes on wire (16000 bits), 2000 bytes captured (16000 bits) on interface 0
14B         == Ethernet II, Src: 50:01:00:04:00:01 (50:01:00:04:00:01), Dst: 50:01:00:05:00:01 (50:01:00:05:00:01)
4B          == 802.1Q Virtual LAN, PRI: 7, CFI: 0, ID: 10
20B         == Internet Protocol Version 4, Src: 192.168.1.1, Dst: 192.168.1.2
1962B       == Internet Control Message Protocol
</code></pre></td></tr></table></div></div><p>In contrast with Nokia, Juniper&rsquo;s configuration of interface is done in a different way.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>root@R2# show interfaces ge-0/0/1
flexible-vlan-tagging;
encapsulation flexible-ethernet-services;
unit 600 {
    encapsulation vlan-vpls;
    vlan-id 600;
}
</code></pre></td></tr></table></div></div><p>In Juniper you have to specify <code>encapsulation vlan-vpls</code> under the interface&rsquo;s configuration for a logical unit you&rsquo;re going to use as an AC.</p><h4 id=service-configuration class=headerLink><a href=#service-configuration class=header-mark></a>Service configuration</h4><p>Now to the main course, service configuration. Both Nokia and Juniper has some vendor-specifics and different defaults worth mentioning.</p><p>Let&rsquo;s take one section at a time and discuss the details. On R1 I configured VPLS service with <code>id 10</code>. The same id I used for RD and RT.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>A:R1# configure service vpls 10
A:R1&gt;config&gt;service&gt;vpls# info
----------------------------------------------
            bgp
                route-distinguisher 1.1.1.1:10
                route-target export target:65000:10 import target:65000:10
                pw-template-binding 11
                exit
            exit
</code></pre></td></tr></table></div></div><p>BGP section of VPLS service has RD/RT values which used for route distinguishing between different VPLS services and auto-discovering based on Route Target.
What is interesting here is <code>pw-template-binding</code> keyword. In SROS we use pseudowire templates to describe pseudowire characteristics. Based on this template PW will later bind to a VPLS service and established.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>A:R1# configure service pw-template 11
A:R1&gt;config&gt;service&gt;pw-template# info
----------------------------------------------
            controlword
            force-vlan-vc-forwarding
            split-horizon-group &#34;mesh&#34;
            exit
----------------------------------------------
</code></pre></td></tr></table></div></div><p>The MPLS transport tunnel between PEs can be signaled using LDP or RSVP-TE. LDP based pseudowires can be automatically instantiated. RSVP-TE based SDPs have to be pre-provisioned. In this post I rely on automatically created LDP LSP. Using this mechanism SDPs will be auto-instantiated.</p><p>A keyword <code>controlword</code> indicates that control word must be used in dataplane.
A pseudowire template is required containing a split horizon group. Each SDP created with this template is contained within a split horizon group so that traffic cannot be forwarded between them.</p><p>By using <code>force-vlan-vc-forwarding</code> command we force a VE router to push service-delimiting vlan-id when sending data on PW (it is PW vlan-tagged mode). By default service-delimiting tag will be stripped off (equals to PW raw mode).</p><p>Next section carries bgp-vpls specific commands:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>bgp-vpls
    max-ve-id 10
    ve-name &#34;BLUE&#34;
    ve-id 1
    exit
    no shutdown
exit
</code></pre></td></tr></table></div></div><p>In this section VPLS Edge name should be configured along with <code>ve-id</code>. What is specific to Nokia SR OS is the necessity to configure <code>max-ve-id</code> value.<br>The choice of ve-id is crucial in ensuring efficient allocation of de-multiplexer labels. The most efficient choice is for ve-ids to be allocated starting at 1 and incrementing for each PE as the following section explains.</p><p>The <code>max-ve-id</code> value determines the range of the ve-id value that can be configured. If a PE receives a BGP-VPLS update containing a ve-id with a greater value than the configured <code>max-ve-id</code>, then the update is dropped and no service labels are installed for this ve-id.</p><blockquote><p>Note: For Juniper it is not mandatory (but possible) to configure maximum VE devices in a service.</p></blockquote><p>The rest of the service configuration goes like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>            stp
                shutdown
            exit
            sap 1/1/2:10 create
                no shutdown
            exit
            no shutdown
</code></pre></td></tr></table></div></div><p>Important part here is <code>sap</code> (service access point) binding. Command <code>sap 1/1/2:10</code> basically tells that frames coming in <code>port 1/1/2</code> encapsulated with <code>vlan-id 10</code> will be attached to this VPLS service. Note, that <code>vlan-id 10</code> is a service delimiter. Read more about processing of vlan tags <a href="https://infocenter.alcatel-lucent.com/public/7750SR140R4/topic/com.sr.l2/html/vpls.html?cp=5_2_2_2#i4833010" target=_blank rel="noopener noreffer">here</a>.</p><p>Since our topology is loop-free we do not need to run STP, thus it is shutdowned.</p><p>Juniper configuration of a service is as follows. A couple of lines need to be explained, while most of them are pretty standard:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>root@R2# show routing-instances VPLS-BLUE
instance-type vpls;
vlan-id 10;
interface ge-0/0/1.600;
route-distinguisher 2.2.2.2:10;
vrf-target target:65000:10;
protocols {
    vpls {
        control-word;
        no-tunnel-services;
        site CE2 {
            site-identifier 2;  ## VE-ID
            interface ge-0/0/1.600;
        }
    }
}
</code></pre></td></tr></table></div></div><p>For VPLS service Juniper offers two types of routing instances: vpls and virtual-switch. Differences between them covered for example in the <a href=http://shop.oreilly.com/product/0636920033905.do>MPLS in the SDN Era</a> book chapter 7. I used a simple <code>vpls</code> instance.</p><p>The reason for <code>no-tunnel-services</code> covered in this <a href=https://www.juniper.net/documentation/en_US/junos14.2/topics/usage-guidelines/vpls-configuring-without-tunnel-services-pic.html>article</a>.</p><p><code>vlan-id 10</code> statement used for vlan-normalization, refer to the next section for the details.</p><h4 id=vlan-handling-in-vpls class=headerLink><a href=#vlan-handling-in-vpls class=header-mark></a>VLAN handling in VPLS</h4><p>Most common problem with VPLS services are VLAN handling when vlan-id on attachment circuits differs. And our topology is a perfect example of this, two ACs use different vlans (10 on R1 and 600 on R2). At the same time these vlan-ids are of service-delimiting purpose, meaning that they are not CE provisioned vlans, but actually SPs assigned for multiplexing different customers/services on a single AC.</p><p>Handling of service-delimiting vlans is different on Nokia and Juniper. Take a look at Fig. 70 and refer once again to <a href=http://shop.oreilly.com/product/0636920033905.do>MPLS in the SDN Era</a> book chapter 7 where each of VLAN modes discussed in details:</p><div align=center><a href=http://img-fotki.yandex.ru/get/172931/21639405.11d/0_8b21d_319fce5b_orig.png><img src=http://img-fotki.yandex.ru/get/172931/21639405.11d/0_8b21d_319fce5b_XL.png alt width=523 height=800></a></div><h4 id=control-plane-walk-through class=headerLink><a href=#control-plane-walk-through class=header-mark></a>Control plane walk through</h4><p>To assemble all the pieces discussed earlier into a picture I will cover things that happen in control and data planes during the VPLS service creation and operation.</p><div align=center><a href=http://img-fotki.yandex.ru/get/58675/21639405.11d/0_8b21e_95f1af3e_orig.png><img src=http://img-fotki.yandex.ru/get/58675/21639405.11d/0_8b21e_95f1af3e_XL.png alt width=800 height=674></a></div><p><strong>Step 1</strong><br>For simplicity of discussion lets assume that router R1 has its VPLS service configured first and send MP-BGP Update to Route Reflector. BGP Update consists of elements we have covered in previous sections of this post.</p><p>Worth mentioning here is that R1 sends only one label block of size 8 (despite that <code>max-ve-id</code> has been configured for 10 VE devices). This is the result of optimization techniques, router does not send all the blocks, it will send ones that necessary once it receive an update message with CE-ID which is not part of blocks advertised by a router so far.</p><p><strong>Step 2</strong><br>R2 receives update from R1 (via R3) and goes through PW setup process discussed earlier. At this step R2 calculates a service MPLS label it will use in the data plane.</p><p><strong>Step 3</strong><br>Now operator enables VPLS service on R2 and its R2&rsquo;s turn to send BGP Update towards R1.</p><p><strong>Step 4</strong><br>R1 follows the same procedure as R2 did in step 2.<br>At the end of control plane messages exchange we should have a pseudowire established with a certain characteristics and the service status should be healthy. Lets ensure that from control plane perspective VPLS service is up and running on both platforms.</p><p>Getting status of VPLS service with id 10:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>A:R1# show service id 10 base 

===============================================================================
Service Basic Information
===============================================================================
Service Id        : 10                  Vpn Id            : 0
Service Type      : VPLS                
Name              : (Not Specified)
Description       : (Not Specified)
Customer Id       : 1                   Creation Origin   : manual
Last Status Change: 03/13/2016 07:59:09 
Last Mgmt Change  : 03/13/2016 07:59:34 
Etree Mode        : Disabled            
Admin State       : Up                  Oper State        : Up
MTU               : 1514                Def. Mesh VC Id   : 10
SAP Count         : 1                   SDP Bind Count    : 1
Snd Flush on Fail : Disabled            Host Conn Verify  : Disabled
SHCV pol IPv4     : None
Propagate MacFlush: Disabled            Per Svc Hashing   : Disabled
Allow IP Intf Bind: Disabled            
Fwd-IPv4-Mcast-To*: Disabled            Fwd-IPv6-Mcast-To*: Disabled
Def. Gateway IP   : None                
Def. Gateway MAC  : None                
Temp Flood Time   : Disabled            Temp Flood        : Inactive
Temp Flood Chg Cnt: 0                   
SPI load-balance  : Disabled            
TEID load-balance : Disabled            
Src Tep IP        : N/A                 
VSD Domain        : &lt;none&gt;
 
-------------------------------------------------------------------------------
Service Access &amp; Destination Points
-------------------------------------------------------------------------------
Identifier Type         AdmMTU  OprMTU  Adm  Opr
-------------------------------------------------------------------------------
sap:1/1/2:10                             q-tag        8704    8704    Up   Up
sdp:17407:4294967293 SB(2.2.2.2)         BgpVpls      0       8678    Up   Up
===============================================================================
</code></pre></td></tr></table></div></div><p>Basic information about a service shows us its Admin and Oper states. As well as <code>sap</code> and <code>sdp</code> this service has along with their statuses.
To see the service labels calculated on a Nokia router you need to query for SDP section of a service:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>A:R1# show service id 10 sdp detail | match &#34;Egress Label&#34;
Ingress Label      : 131064                   Egress Label      : 262145
</code></pre></td></tr></table></div></div><p>So R1 will use service label <code>262145</code> when will send traffic destined to a VPLS service configure on R2.</p><p>For Juniper basic verification of VPLS service goes like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>root@R2# run show vpls connections instance VPLS-BLUE 

Layer-2 VPN connections:
Instance: VPLS-BLUE
  Local site: CE2 (2)
    Number of local interfaces: 1
    Number of local interfaces up: 1
    IRB interface present: no
    ge-0/0/1.600       
    lsi.1049088         1         Intf - vpls VPLS-BLUE local site 2 remote site 1
    Label-base        Offset     Size  Range     Preference
    262145            1          8      8         100   
    connection-site           Type  St     Time last up          # Up trans
    1                         rmt   Up     Nov 11 19:30:43 2016           1
      Remote PE: 1.1.1.1, Negotiated control-word: Yes (Null)
      Incoming label: 262145, Outgoing label: 131064
      Local interface: lsi.1049088, Status: Up, Encapsulation: VPLS
        Description: Intf - vpls VPLS-BLUE local site 2 remote site 1
    Connection History:
        Nov 11 19:30:43 2016  status update timer  
        Nov 11 19:30:43 2016  loc intf up                  lsi.1049088
        Nov 11 19:30:43 2016  PE route changed     
        Nov 11 19:30:43 2016  Out lbl Update                    131064
        Nov 11 19:30:43 2016  In lbl Update                     262145
        Nov 11 19:30:43 2016  loc intf down
</code></pre></td></tr></table></div></div><p>Both access (ge-0/0/1.600) and tunnel (lsi.1049088) interfaces are shown along with calculated service label values.</p><h4 id=data-plane-walk-through class=headerLink><a href=#data-plane-walk-through class=header-mark></a>Data plane walk through</h4><p>And now we are ready to explore data plane! In VPLS data plane is crucial as it is the only way how MAC addresses can be learned. With this being said it is clear that since no MACs were learned during control plane messages exchange, CE devices <strong>have no ARP entries</strong> except for their own IP addresses.</p><div align=center><a href=http://img-fotki.yandex.ru/get/6300/21639405.11d/0_8b21f_f3c8fcab_orig.png><img src=http://img-fotki.yandex.ru/get/6300/21639405.11d/0_8b21f_f3c8fcab_XL.png alt width=683 height=800></a></div><p><strong>ARP handling</strong><br>To demonstrate data plane operations I will issue a ping from CE1 (<code>192.168.1.1/24</code>) to CE2 (<code>192.168.1.2/24</code>). Since ARP table on CE1 is empty it is necessary to start with ARP request, but to keep this section a bit shorter I will omit ARP packets propagation since the same path will IP packets take.</p><p>The only difference ARP packets have is that they represent layer 2 broadcast traffic, therefore these traffic will be replicated by VPLS VE router and sent out from any local VPLS interface as well as out from every pseudowire of particular VPLS instance.
During ARP packets propagation local MAC tables on R1 and R2 will be populated with MAC-IP pairs of CE routers.</p><p><strong>Known unicast</strong><br>Thanks to ARP process, a packet destined from CE1 to CE2 will be a known unicast by nature, since destination IP address of <code>192.168.1.2</code> is known in VPLS MAC tables of R1 and R2.</p><div align=center><a href=http://img-fotki.yandex.ru/get/196736/21639405.11d/0_8b220_4b717aba_orig.png><img src=http://img-fotki.yandex.ru/get/196736/21639405.11d/0_8b220_4b717aba_XL.png alt width=800 height=734></a></div><p><strong>Step 1</strong><br>When a request to ping CE2 address arises on CE1, the latter checks its ARP table to see if it has Layer 2 address corresponding to this IP. Since ARP process has already been done, CE1 has MAC address of CE2 resolved. Thus it can construct the whole frame and send it out via its interface towards R1.</p><p>Since interface <code>toCE2</code> has particular <code>VLAN ID 10</code> assigned, the resulting packet will resemble the following structure ICMP-IP-VlanID-Ethernet:</p><p>Note, no MPLS encapsulation happens on the wire between CE1 and R1, it is plain IP packet with Ethernet on data layer.</p><p><strong>Step 2</strong><br>At Step 2.1 R1 receives the data on the service access point <code>1/1/2:10</code> which is included in VPLS service with <code>id 10</code>. R1 queries with destination MAC address (<code>50:01:00:05:00:01</code>) VPLS&rsquo;s forwarding database (fdb or MAC table) and (thanks to previous ARP messages) matches a service distribution point (sdp or transport tunnel) where this MAC was learned from.</p><p>R1 knows what label (or demultiplexor) it should use when placing a customers packet on a pseudowire, this label were calculated based on the seed material received during control plane operations. Step 2.3 depicts how R1 assembles all the pieces to place a packet on a PW. It is worth to note that we see only service label on the wire, transport label is missing due to <code>implicit null</code> label received from R2.</p><div align=center><a href=http://img-fotki.yandex.ru/get/196237/21639405.11d/0_8b221_60a6cbba_orig.png><img src=http://img-fotki.yandex.ru/get/196237/21639405.11d/0_8b221_60a6cbba_XL.png alt width=800 height=791></a></div><p><strong>Step 3</strong><br>When R2 receives a packet from R1 it strips Ethernet and VLAN headers and analyzes a MPLS label. As was discussed, label values were calculated during control plane convergency, therefore R2 has a proper label action for a label value of <code>262145</code> (Step 3.2).</p><p>By using <code>no-tunnel-services</code> command on R2 we created a label-switched interface (LSI) to provide VPLS functionality. An LSI MPLS label is used as the inner label for VPLS. This label maps to a VPLS routing instance. On the PE router, the LSI label is stripped and then mapped to a logical LSI interface. The Layer 2 Ethernet frame is then forwarded using the LSI interface to the correct VPLS routing instance. Step 3.1 shows LSI interface and VPLS service binding.</p><p>Since VPLS service behaves like a normal switch packet forwarding decisions are based on MAC table lookup. So far we decapsulated our packet up customer Ethernet header, which has <code>Dest MAC: 50:01:00:05:00:01</code>. R2 consults a MAC table inside VPLS service (Step 3.3) and finds out that destination MAC was seen behind <code>ge-0/0/1.600</code> interface (this MAC was learned during ARP operation). This information is enough for R2 to decide in what direction customers traffic should go further.</p><p>Step 3.4 shows that R2 sends out of its <code>ge-0/0/0.600</code> interface a packet towards a recipient CE2 and uses the <code>VLAN ID 600</code> since this is the tag used by this attachment circuit. Note, that in step 2.3 we had <code>VLAN ID 10</code> placed by R1 because of <code>force-vlan-vc-forwarding</code> command on R1. This VLAN has been recognized by R2 because of this part in its service configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>root@R2# show routing-instances VPLS-BLUE
instance-type vpls;
vlan-id 10;
interface ge-0/0/1.600;
route-distinguisher 2.2.2.2:10;
vrf-target target:65000:10;
protocols {
    vpls {
        control-word;
        no-tunnel-services;
        site CE2 {
            site-identifier 2;  ## VE-ID
            interface ge-0/0/1.600;
        }
    }
}
</code></pre></td></tr></table></div></div><p>R2 sees that this is the VLAN ID used by VPLS and swaps it with VLAN ID used on its attachment circuit when sending traffic out of its <code>ge-0/0/0.600</code> interface.This is how you normalize VLAN IDs in data plane.</p><p><strong>Step 4</strong><br>In the end CE2 receives a standard ICMP packet encapsulated within Ethernet 802.1q frame and processes it accordingly.</p><p>Return traffic follows the same login in the opposite direction with a slight change in MPLS operation. Since Nokia vSR does not use implicit null label, you will see two labels in the data plane between R2 and R1. Top label will be LDP transport label, and bottom label will act as a service VPLS label.</p><h3 id=references--further-reading class=headerLink><a href=#references--further-reading class=header-mark></a>References & further reading</h3><ul><li><a href=http://www.rfcreader.com/#rfc4761>RFC4761</a> Virtual Private LAN Service (VPLS) Using BGP for Auto-Discovery and Signaling</li><li><a href=http://www.rfcreader.com/#rfc4448>RFC4448</a> Encapsulation Methods for Transport of Ethernet over MPLS Networks</li><li><a href=https://tools.ietf.org/html/draft-ietf-bess-vpls-multihoming>draft-vpls-multihoming</a> BGP based Multi-homing in Virtual Private LAN Service</li><li><a href="https://infocenter.alcatel-lucent.com/public/7750SR140R4/topic/com.sr.l2/html/vpls_config.html?cp=5_2_5">Configuring VPLS on SR OS</a></li><li><a href=https://www.juniper.net/techpubs/en_US/junos14.1/topics/concept/vpn-vpls-introduction.html>VPLS Services</a> in JunOS</li><li><a href=https://infoproducts.alcatel-lucent.com/html/0_add-h-f/93-0267-HTML/7X50_Advanced_Configuration_Guide/BGP-VPLS.html>Configuring and troubleshooting BGP VPLS on Nokia SROS</a></li><li><a href="https://infocenter.alcatel-lucent.com/public/7750SR140R4/topic/com.sr.l2/html/vpls.html?cp=5_2">VPLS services explained (Nokia official doc)</a></li><li><a href=http://shop.oreilly.com/product/0636920033905.do>MPLS in the SDN Era</a></li></ul></div><footer><div class=post><div class=post-share><div class=share-link><a class="share-icon share-twitter" href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://netdevops.me/2016/11/bgp-vpls-explained-nokia-juniper/ data-title="BGP VPLS deep dive. Nokia SR OS & Juniper" data-via=ntdvps data-hashtags=bgp,vpls,nokia,juniper><span class="svg-social-icon icon-twitter"></span></a></div><div class=share-link><a class="share-icon share-facebook" href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://netdevops.me/2016/11/bgp-vpls-explained-nokia-juniper/ data-hashtag=bgp><span class="svg-social-icon icon-facebook"></span></a></div><div class=share-link><a class="share-icon share-linkedin" href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://netdevops.me/2016/11/bgp-vpls-explained-nokia-juniper/><span class="svg-social-icon icon-linkedin"></span></a></div></div><div class=post-tags><a href=/tags/bgp/ class=tag>BGP</a><a href=/tags/vpls/ class=tag>vpls</a><a href=/tags/nokia/ class=tag>Nokia</a><a href=/tags/juniper/ class=tag>Juniper</a></div></div></footer></div><div id=toc-final></div></div></article><aside class=article-post><div class="content-block content-block-position block-donate"><div class=post><div class=title><div style=text-align:center><svg width="90" height="90" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#fff" d="M376 30c-27.783.0-53.255 8.804-75.707 26.168-21.525 16.647-35.856 37.85-44.293 53.268-8.437-15.419-22.768-36.621-44.293-53.268C189.255 38.804 163.783 30 136 30 58.468 30 0 93.417.0 177.514c0 90.854 72.943 153.015 183.369 247.118l62.099 53.414C248.38 480.596 252.12 482 256 482s7.62-1.404 10.532-3.953l62.111-53.425C439.057 330.529 512 268.368 512 177.514 512 93.417 453.532 30 376 30z"/></svg></div><div style=text-align:center;margin-top:20px><span class=title>If any of my work was helpful, you can:</span></div></div><div class=donate-text><ul><li>✉️ Share this post with your colleagues</li><li>💬 Comment, ask questions and report any issues/typos found</li><li>💰 Make a one-time or recurring donation to support my work</li></ul></div><div class=donate-button><a href=https://github.com/sponsors/hellt class="button button-big button-white">Donate</a></div></div></div></aside><section class="page single comments content-block-position"><h1 class=display-hidden>Комментарии</h1><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></section></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.82.0">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://netdevops.me/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target=_blank title="uBlogger 2.0.1">uBlogger</a></div><div class=footer-line><i class="svg-icon icon-copyright"></i><span>2015 - 2021</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><aside id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="svg-icon icon-arrow-up"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="svg-icon icon-comments-fixed"></i></a></aside><link rel=stylesheet href=/drawio.css><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/autocomplete/autocomplete.min.js></script><script src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script src=/lib/sharer/sharer.min.js></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:20},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"comment",lightTheme:"github-light",repo:"hellt/netdevops.me"}},search:{algoliaAppID:"H1AI8QKFEK",algoliaIndex:"blog",algoliaSearchKey:"0544bc3c928ba0e387c3b3353112e43d",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:60,type:"algolia"}}</script><script src=/js/theme.min.js></script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-101537614-1','auto'),ga('send','pageview')</script></body></html>