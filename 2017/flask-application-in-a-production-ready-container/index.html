<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Flask application in a production-ready container |</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content><meta name=twitter:title content="Flask application in a production-ready container"><meta name=twitter:description content><meta name=twitter:creator content="@ntdvps"><meta name=Description content="DevOps applied to networking"><meta property="og:title" content="Flask application in a production-ready container"><meta property="og:description" content="Flask documentation is very clear on where is the place for its built-in WSGI application server:

While lightweight and easy to use, Flask’s built-in server is not suitable for production as it doesn’t scale well and by default serves only one request at a time.

So how about I share with you a Dockerfile that will enable your Flask application to run properly and ready for production-like deployments? As a bonus, I will share my findings discovered along the way of building this container image.





"><meta property="og:type" content="article"><meta property="og:url" content="https://netdevops.me/2017/flask-application-in-a-production-ready-container/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-11-09T12:00:00+00:00"><meta property="article:modified_time" content="2021-04-19T12:35:46+02:00"><meta name=application-name content="NetDevOps"><meta name=apple-mobile-web-app-title content="NetDevOps"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=192x192 href=/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=/android-chrome-512x512.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://netdevops.me/2017/flask-application-in-a-production-ready-container/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Flask application in a production-ready container","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/netdevops.me\/2017\/flask-application-in-a-production-ready-container\/"},"genre":"posts","keywords":"Flask, nginx, uWSGI, Docker","wordCount":1762,"url":"https:\/\/netdevops.me\/2017\/flask-application-in-a-production-ready-container\/","datePublished":"2017-11-09T12:00:00+00:00","dateModified":"2021-04-19T12:35:46+02:00","description":""}</script></head><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header><div class="desktop header" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=NetDevOps class="header-logo logo-svg">NetDevOps</a></div><div class=menu><nav><h2 class=display-hidden>Основная навигация</h2><ul class=menu-inner><li><a class=menu-item href=/posts/>Posts</a></li><li><a class=menu-item href=/tags/>Tags</a></li></ul></nav><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=Search... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><span class="svg-icon icon-search"></span></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><span class="svg-icon icon-cancel"></span></a><span class="search-button search-loading" id=search-loading-desktop><span class="svg-icon icon-loading"></span></span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></div><div class="mobile header" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=NetDevOps class=header-logo>NetDevOps</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=Search... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><span class="svg-icon icon-search"></span></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><span class="svg-icon icon-cancel"></span></a><span class="search-button search-loading" id=search-loading-mobile><span class="svg-icon icon-loading"></span></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><nav><h2 class=display-hidden>Основная навигация</h2><ul><li><a class=menu-item href=/posts/ title>Posts</a></li><li><a class=menu-item href=/tags/ title>Tags</a></li></ul></nav><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></div><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div></header><main class=main><div class="container content-article theme-classic"><div class=toc id=toc-auto><div class=toc-title>Contents</div><div class="toc-content always-active" id=toc-content-auto></div></div><article><header class=header-post><div class=post-title><div class=post-all-meta><nav class=breadcrumbs><ol><li><a href=/>Home</a></li><li>Flask application in a production-ready container</li></ol></nav><h1 class="single-title flipInX">Flask application in a production-ready container</h1><div class="post-meta summary-post-meta"><span class="post-meta-date meta-item"><span class="svg-icon icon-clock"></span><time class=timeago datetime=2017-11-09>2017-11-09</time>
</span><span class="post-meta-words meta-item"><span class="svg-icon icon-pencil"></span>1762 words</span>
<span class="post-meta-reading meta-item"><span class="svg-icon icon-stopwatch"></span>9 minutes</span></div></div></div></header><div class="article-post toc-start"><div class="content-block content-block-first content-block-position"><div class="post single"><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#why-do-we-even-need-nginx-and-uwsgi-in-front-of-flask>Why do we even need nginx and uWSGI in front of Flask?</a></li><li><a href=#do-i-need-a-_production-grade_-flask-app-for-a-pet-project>Do I need a <em>production grade</em> Flask app for a pet project?</a></li><li><a href=#configuring-nginx>Configuring nginx</a><ul><li><a href=#nginx-global-config>nginx global config</a></li><li><a href=#nginx-site-config>nginx site config</a></li></ul></li><li><a href=#uwsgi-configuration>uWSGI configuration</a><ul><li><a href=#module-and-callable>Module and Callable</a></li><li><a href=#plugins>Plugins</a></li><li><a href=#uid-gid>uid, gid</a></li><li><a href=#socket-configuration>Socket configuration</a></li></ul></li><li><a href=#processes-configuration>Processes configuration</a></li><li><a href=#supervisord-to-rule-them-all>Supervisord to rule them all</a></li><li><a href=#lets-load-it-in-a-container>Lets load it in a container?</a></li><li><a href=#enjoying-the-result>Enjoying the result</a></li><li><a href=#how-do-i-use-this-one>How do I use this one?</a></li></ul></nav></div></div><div style="margin:20px 0"><span class=post-update><span class=s>Updated on 2021-04-19</span></span></div><p>Flask documentation <a href=http://flask.pocoo.org/docs/0.12/deploying/#deployment-options target=_blank rel="noopener noreffer">is very clear</a> on where is the place for its built-in WSGI application server:</p><blockquote><p>While lightweight and easy to use, <strong>Flask’s built-in server is not suitable for production</strong> as it doesn’t scale well and by default serves only one request at a time.</p></blockquote><p>So how about I share with you a <a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker target=_blank rel="noopener noreffer"><em>Dockerfile</em></a> that will enable your Flask application to run <strong>properly</strong> and ready for production-like deployments? As a bonus, I will share my findings discovered along the way of building this container image.</p><p><img loading=lazy decoding=async class=render-image src=https://gitlab.com/rdodin/netdevops.me/uploads/e893ab9ea824ed501170908377d3fb52/image.png alt=nginx-uwsgi-flaks-alpine-docker title=image.png></p><p>But before we dive in and start throwing words like uwsgi, nginx and sockets lets set up our vocabulary. As DigitalOcean originally wrote:</p><blockquote><ul><li><a href=https://www.python.org/dev/peps/pep-3333/ target=_blank rel="noopener noreffer"><strong>WSGI</strong></a>: A Python spec that defines a standard interface for communication between an application or framework and an application/web server. This was created in order to simplify and standardize communication between these components for consistency and interchangeability. This basically defines an API interface that can be used over other protocols.</li><li><a href=https://uwsgi-docs.readthedocs.io/en/latest/ target=_blank rel="noopener noreffer"><strong>uWSGI</strong></a>: An application server container that aims to provide a full stack for developing and deploying web applications and services. The main component is an application server that can handle apps of different languages. It communicates with the application using the methods defined by the WSGI spec, and with other web servers over a variety of other protocols. This is the piece that translates requests from a conventional web server into a format that the application can process.</li><li><a href=https://uwsgi-docs.readthedocs.io/en/latest/Protocol.html target=_blank rel="noopener noreffer"><strong>uwsgi</strong></a>: A fast, binary protocol implemented by the uWSGI server to communicate with a more full-featured web server. This is a wire protocol, not a transport protocol. It is the preferred way to speak to web servers that are proxying requests to uWSGI.</li></ul></blockquote><h2 id=why-do-we-even-need-nginx-and-uwsgi-in-front-of-flask class=headerLink><a href=#why-do-we-even-need-nginx-and-uwsgi-in-front-of-flask class=header-mark></a>Why do we even need nginx and uWSGI in front of Flask?</h2><p>That is the question everyone should ask. Main reason is performance, of course. The Flasks built-in web server is a development server by <a href=https://werkzeug.palletsprojects.com/ target=_blank rel="noopener noreffer">Werkzeug</a> which was not designed to be particularly efficient, stable, or secure.<br>And by all means Werkzeug was not optimized to serve static content, that is why production deployments of Flask apps rely on the following stack:</p><ol><li><strong>Front-end web-server</strong> (nginx or Apache): load balancing, SSL termination, rate limiting, HTTP parsing and serving static content.</li><li><strong>WSGI application server</strong> (uWSGI, Gunicorn, CherryPy): runs WSGI compliant web applications and does it in a production-grade manner. Handling concurrent requests, process management, cluster membership, logging, configuration, shared memory, etc.</li></ol><p>Obviously, development server which comes with Flask simply does not bother about all these tasks that production deployments face. That is why it is so strongly advised against using Flask' server in any kind of production.</p><blockquote><p>Speaking about the performance I suggest to check out this presentation from Pycon IE &lsquo;13 called <a href=http://brianmcdonnell.github.io/pycon_ie_2013/#/ target=_blank rel="noopener noreffer"><em>Maximum Throughput (baseline costs of web frameworks)</em></a> that explains how number of queries per second depends on web stack you choose.</p></blockquote><p>While there are many alternatives to <a href=https://nginx.ru/en/ target=_blank rel="noopener noreffer"><code>nginx</code></a>+<a href=https://uwsgi-docs.readthedocs.io/en/latest/ target=_blank rel="noopener noreffer"><code>uWSGI</code></a> pair, I will focus on these two in this post.</p><h2 id=do-i-need-a-_production-grade_-flask-app-for-a-pet-project class=headerLink><a href=#do-i-need-a-_production-grade_-flask-app-for-a-pet-project class=header-mark></a>Do I need a <em>production grade</em> Flask app for a pet project?</h2><p>While you may go with built-in Flask server for the little projects of your own, this container is so simple that you would not need to use the Built-in server anymore. Why opting out for testing server, if it is easy to launch it in a production-ready way?</p><h2 id=configuring-nginx class=headerLink><a href=#configuring-nginx class=header-mark></a>Configuring nginx</h2><p>We start with configuration of <code>nginx</code> server that will face incoming traffic and handle it for us.</p><blockquote><p>We also keep in mind that our nginx server will run in an Alpine Linux docker container.</p></blockquote><p>nginx config consists of two parts:</p><ul><li>global nginx config file (<a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker/blob/master/python2/nginx.conf target=_blank rel="noopener noreffer"><code>nginx.conf</code></a>)</li><li>site-specific config file (<a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker/blob/master/python2/flask-site-nginx.conf target=_blank rel="noopener noreffer"><code>flask-site-nginx.conf</code></a>)</li></ul><h3 id=nginx-global-config class=headerLink><a href=#nginx-global-config class=header-mark></a>nginx global config</h3><p>For the <strong>global nginx config file</strong> I combined the recommendations outlined in the post <a href=http://www.patricksoftwareblog.com/how-to-configure-nginx-for-a-flask-web-application/ target=_blank rel="noopener noreffer"><em>How to Configure NGINX for a Flask Web Application</em></a> with <a href=https://uwsgi-docs.readthedocs.io/en/latest/Nginx.html target=_blank rel="noopener noreffer">nginx configuration samples</a> from uWSGI docs.</p><p>A little caveat that you might encounter when deploying nginx in Alpine Linux renders itself like that:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-plain data-lang=plain>Error: nginx: [emerg] open() &#34;/run/nginx/nginx.pid&#34; failed (2: No such file or directory)
</code></pre></td></tr></table></div></div><p>All you need to do is to to <a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker/blob/master/python2/nginx.conf#L10 target=_blank rel="noopener noreffer">change pid file location</a> since <code>/run/</code> path is not available in Alpine Linux.</p><h3 id=nginx-site-config class=headerLink><a href=#nginx-site-config class=header-mark></a>nginx site config</h3><p>Site config (<a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker/blob/master/python2/flask-site-nginx.conf target=_blank rel="noopener noreffer"><code>flask-site-nginx.conf</code></a>) is short and simple:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>server {
    location / {
        try_files $uri @yourapplication;
    }
    location @yourapplication {
        include uwsgi_params;
        uwsgi_pass unix:///tmp/uwsgi.sock;
    }
    # Configure NGINX to deliver static content from the specified folder
    location /static {
        alias /app/static;
    }
}
</code></pre></td></tr></table></div></div><p>Basically, all you saying here is that your application will be served at <code>/</code> endpoint and use <code>uwsgi</code> wire protocol via unix socket at <code>unix:///tmp/uwsgi.sock</code>.</p><p>Also we ask nginx to serve static content that is stored in <code>/app/static</code>.</p><p>Communication path between nginx and WSGI app server can be configured with different sockets and protocols, but <code>unix_socket + uwsgi protocol</code> tends to be the most appropriate way.</p><blockquote><p><img loading=lazy decoding=async class=render-image src=https://gitlab.com/rdodin/netdevops.me/uploads/a618d2c1e3d19c9a8dbf9d2d23f2cbd9/image.png alt=sockets_perf title=image.png>
The uwsgi protocol is derived from SCGI but with binary string length representations and a 4-byte header that includes the size of the var block (16 bit length) and a couple of general-purpose bytes. Binary management is much easier and cheaper than string parsing.</p></blockquote><p>So far we dealt with the first bastion, which is nginx config. Our configuration path can be depicted as that:</p><blockquote><p><img loading=lazy decoding=async class=render-image src=https://gitlab.com/rdodin/netdevops.me/uploads/b6102940c48b80bcb7578cf9c53daf0e/image.png alt=nginx_configured title=image.png></p></blockquote><h2 id=uwsgi-configuration class=headerLink><a href=#uwsgi-configuration class=header-mark></a>uWSGI configuration</h2><p>uWSGI <a href=https://uwsgi-docs.readthedocs.io/ target=_blank rel="noopener noreffer">documentation</a> is extensive, you may find all the tweaks and recommendations for the wide range of deployment scenarios. Since this container we build is of general purpose, a sensible uWSGI configuration file (<a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker/blob/master/python2/uwsgi.ini target=_blank rel="noopener noreffer"><code>uwsgi.ini</code></a>) could look as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-toml data-lang=toml><span class=p>[</span><span class=nx>uwsgi</span><span class=p>]</span>
<span class=nx>module</span> <span class=p>=</span> <span class=nx>main</span>
<span class=nx>callable</span> <span class=p>=</span> <span class=nx>app</span>
<span class=nx>plugins</span> <span class=p>=</span> <span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>lib</span><span class=err>/</span><span class=nx>uwsgi</span><span class=err>/</span><span class=nx>python</span>

<span class=nx>uid</span> <span class=p>=</span> <span class=nx>nginx</span>
<span class=nx>gid</span> <span class=p>=</span> <span class=nx>nginx</span>

<span class=nx>socket</span> <span class=p>=</span> <span class=err>/</span><span class=nx>tmp</span><span class=err>/</span><span class=nx>uwsgi</span><span class=p>.</span><span class=nx>sock</span>
<span class=nx>chown</span><span class=err>-</span><span class=nx>socket</span> <span class=p>=</span> <span class=nx>nginx</span><span class=err>:</span><span class=nx>nginx</span>
<span class=nx>chmod</span><span class=err>-</span><span class=nx>socket</span> <span class=p>=</span> <span class=mi>664</span>

<span class=nx>cheaper</span> <span class=p>=</span> <span class=mi>1</span>
<span class=nx>processes</span> <span class=p>=</span> <span class=err>%(%</span><span class=nx>k</span> <span class=err>+</span> <span class=mi>1</span><span class=err>)</span>
</code></pre></td></tr></table></div></div><p>This configuration file consists of uWSGI options each of which is <a href=https://uwsgi-docs.readthedocs.io/en/latest/Options.html target=_blank rel="noopener noreffer">documented</a> quite extensively.</p><h3 id=module-and-callable class=headerLink><a href=#module-and-callable class=header-mark></a>Module and Callable</h3><p>We start with defining where is an entry point for uWSGI server to call our app.<br>The <a href=https://uwsgi-docs.readthedocs.io/en/latest/Options.html#module target=_blank rel="noopener noreffer"><code>module</code></a> directive corresponds to the name of the python module holding your app. In my case the demo Flask app I built is contained in the <a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker/blob/master/python2/app/main.py target=_blank rel="noopener noreffer"><code>main.py</code></a> file, hence the <code>main</code> module name.<br>On the other hand, <a href=https://uwsgi-docs.readthedocs.io/en/latest/Options.html#callable target=_blank rel="noopener noreffer"><code>callable</code></a> is the name of an object inside your module, which is a Flask application entry point.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># coding: utf-8</span>
<span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span>

<span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<span class=c1># rest output is omitted</span>
</code></pre></td></tr></table></div></div><p>For me, its the <code>app</code> variable that should be populated to the <code>callable</code> parameter.</p><h3 id=plugins class=headerLink><a href=#plugins class=header-mark></a>Plugins</h3><p>uWSGI is modular and language-agnostic. In Apline Linux deployments it comes with core features built in, but python support is not one of them.</p><blockquote><p>uWSGI can include features in the core or as loadable plugins. uWSGI packages supplied with OS distributions tend to be modular. In such setups, be sure to load the plugins you require with the plugins option.</p></blockquote><p>That is why <a href=https://uwsgi-docs.readthedocs.io/en/latest/Options.html#plugins target=_blank rel="noopener noreffer"><code>plugins</code></a> parameter is needed where we specify where to find the python plugin. I installed <code>uwsgi-python</code> via apt package manager, this step will be covered as we move to Dockerfile explanation section.</p><h3 id=uid-gid class=headerLink><a href=#uid-gid class=header-mark></a>uid, gid</h3><p>Common sense: do not run uWSGI instances as root. You can start your uWSGIs as root, but be sure to drop privileges with the uid and gid options.</p><p>I dropped privileges to <code>nginx</code> user level.</p><h3 id=socket-configuration class=headerLink><a href=#socket-configuration class=header-mark></a>Socket configuration</h3><p>As you remember, we agreed that uwsgi protocol over unix socket will be used as a communication suite between nginx and uWSGI. We already told so to nginx, now its time for uWSGI.</p><p>Same <code>/tmp/uwsgi.sock</code> is referenced in this <code>uwsgi.ini</code> file. Moreover, we change permissions to that socket file to be readable for <code>nginx</code> user.</p><h2 id=processes-configuration class=headerLink><a href=#processes-configuration class=header-mark></a>Processes configuration</h2><p>uWSGI can spawn multiple processes to run your Flask app, being very productive. But, you need to thoroughly calculate how many processes and threads works for your particular situation.</p><blockquote><p>There is no magic rule for setting the number of processes or threads to use. It is very much application and system dependent. Simple math like <code>processes = 2 * cpucores</code> will not be enough. You need to experiment with various setups and be prepared to constantly monitor your apps. <code>uwsgitop</code> could be a great tool to find the best values.</p></blockquote><p>In our config file these two lines will do the trick:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>cheaper = 1
processes = %(%k + 1)
</code></pre></td></tr></table></div></div><p>With <code>cheaper = 1</code> we activate the <a href=http://uwsgi-docs.readthedocs.io/en/latest/Cheaper.html target=_blank rel="noopener noreffer">The uWSGI cheaper subsystem</a> which allows to dynamically scale the number of running workers (processes). So under the minimum load uWSGI will spawn just one workers.</p><p>The upper limit is dictated by <code>processes = %(%k + 1)</code> statement. The <code>%k</code> is a <a href=https://uwsgi-docs.readthedocs.io/en/latest/Configuration.html#magic-variables target=_blank rel="noopener noreffer">magic variable</a>, which will be resolved by uWSGI to the number of available cores. So for a single core system, number of max workers will be <code>1 + 1 = 2</code>.</p><p>We finished another configuration block:</p><blockquote><p><img loading=lazy decoding=async class=render-image src=https://gitlab.com/rdodin/netdevops.me/uploads/3a0a46936db55c52f4f5750cf4e9ab36/image.png alt=nginx_uwsgi_configured title=image.png></p></blockquote><h2 id=supervisord-to-rule-them-all class=headerLink><a href=#supervisord-to-rule-them-all class=header-mark></a>Supervisord to rule them all</h2><p>A cherry on a pie is to use the <code>supervisord</code> service to manage nginx and uWSGI. For that we create <a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker/blob/master/python2/supervisord.conf target=_blank rel="noopener noreffer"><code>supervisord.conf</code></a> with a plain and simple config.</p><p>Supervisord will watch for these process and restart/start them automatically if things go south for one of them.</p><h2 id=lets-load-it-in-a-container class=headerLink><a href=#lets-load-it-in-a-container class=header-mark></a>Lets load it in a container?</h2><p>Our final part will be creating a lightweight Alpine Linux Docker container image that will have all these parts inside ready to consume.</p><p>Refer to this comments-rich <a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker/blob/master/python2/Dockerfile target=_blank rel="noopener noreffer">Dockerfile</a> where we glue together all the things we discussed above in a docker image.</p><p>One thing to mention here is that python2 and python3 uWSGI plugins are separate packages in Alpine packages system.</p><h2 id=enjoying-the-result class=headerLink><a href=#enjoying-the-result class=header-mark></a>Enjoying the result</h2><p>I built <a href=https://hub.docker.com/r/hellt/nginx-uwsgi-flask-alpine-docker/ target=_blank rel="noopener noreffer">two container images</a> for python2 and python3 respectively along with a sample python application. Lets taste them out:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># pull the image (tagged py2 or py3 respectively)</span>
<span class=o>[</span>ec2~<span class=o>]</span>$ sudo docker pull hellt/nginx-uwsgi-flask-alpine-docker:py3
py3: Pulling from hellt/nginx-uwsgi-flask-alpine-docker
b56ae66c2937: Already exists
<span class=c1># omitted</span>
Status: Downloaded newer image <span class=k>for</span> hellt/nginx-uwsgi-flask-alpine-docker:py3
</code></pre></td></tr></table></div></div><p>The image is very lightweight (62 MB):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>REPOSITORY                              TAG                 IMAGE ID            CREATED             SIZE
hellt/nginx-uwsgi-flask-alpine-docker   py3                 7fb6af3baf0e        6 minutes ago       62.5 MB
</code></pre></td></tr></table></div></div><p>Since docker image contains a sample application we can run it to test that everything works as expected:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo docker run -p 38080:80 hellt/nginx-uwsgi-flask-alpine-docker:py3
</code></pre></td></tr></table></div></div><blockquote><p><img loading=lazy decoding=async class=render-image src=https://gitlab.com/rdodin/netdevops.me/uploads/36bf92416a511abfd642d15de44e9387/image.png alt=final_result title=image.png>
Voila</p></blockquote><h2 id=how-do-i-use-this-one class=headerLink><a href=#how-do-i-use-this-one class=header-mark></a>How do I use this one?</h2><p>First of all, there is no need to use the image from the docker hub, it was created for demonstration purposes. To create the same container but for your application, consider the following steps:</p><ol><li>Clone the <a href=https://github.com/hellt/nginx-uwsgi-flask-alpine-docker target=_blank rel="noopener noreffer">repo</a> with the Dockerfile and configuration files</li><li>Tune the config files if necessary:<ol><li>Tune <code>uwsgi.ini</code> config: i.e. <code>cheaper</code> number and <code>processes</code> to match your hardware</li><li>Enhance nginx config</li></ol></li><li>Copy your app to the <code>/app</code> subdirectory and you are good to build your image</li></ol></div><footer><div class=post><div class=post-share><div class=share-link><a class="share-icon share-twitter" href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://netdevops.me/2017/flask-application-in-a-production-ready-container/ data-title="Flask application in a production-ready container" data-via=ntdvps data-hashtags=Flask,nginx,uWSGI,Docker><span class="svg-social-icon icon-twitter"></span></a></div><div class=share-link><a class="share-icon share-facebook" href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://netdevops.me/2017/flask-application-in-a-production-ready-container/ data-hashtag=Flask><span class="svg-social-icon icon-facebook"></span></a></div><div class=share-link><a class="share-icon share-linkedin" href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://netdevops.me/2017/flask-application-in-a-production-ready-container/><span class="svg-social-icon icon-linkedin"></span></a></div></div><div class=post-tags><a href=/tags/flask/ class=tag>Flask</a><a href=/tags/nginx/ class=tag>nginx</a><a href=/tags/uwsgi/ class=tag>uWSGI</a><a href=/tags/docker/ class=tag>Docker</a></div></div></footer></div><div id=toc-final></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.82.0">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://netdevops.me/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target=_blank title="uBlogger 2.0.1">uBlogger</a></div><div class=footer-line><i class="svg-icon icon-copyright"></i><span>2015 - 2021</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><aside id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="svg-icon icon-arrow-up"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="svg-icon icon-comments-fixed"></i></a></aside><link rel=stylesheet href=/drawio.css><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/autocomplete/autocomplete.min.js></script><script src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script src=/lib/sharer/sharer.min.js></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:20},search:{algoliaAppID:"H1AI8QKFEK",algoliaIndex:"blog",algoliaSearchKey:"0544bc3c928ba0e387c3b3353112e43d",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:60,type:"algolia"}}</script><script src=/js/theme.min.js></script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-101537614-1','auto'),ga('send','pageview')</script></body></html>