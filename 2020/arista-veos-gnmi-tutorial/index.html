<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Arista vEOS gNMI Tutorial |</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content><meta name=twitter:title content="Arista vEOS gNMI Tutorial"><meta name=twitter:description content><meta name=twitter:creator content="@ntdvps"><meta name=Description content="DevOps applied to networking"><meta property="og:title" content="Arista vEOS gNMI Tutorial"><meta property="og:description" content="We were pleasantly surprised by the way community appreciated gNMIc release. Thank you üôè! That solidifies the fact that a well-formed, documented and easy to use gNMI tool was needed.
Now with gNMIc available to everybody its easy like never before to test gNMI implementation of different routing OSes. And in this post we will get our hands on Arista vEOS."><meta property="og:type" content="article"><meta property="og:url" content="https://netdevops.me/2020/arista-veos-gnmi-tutorial/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-25T07:00:00+00:00"><meta property="article:modified_time" content="2021-04-19T12:35:46+02:00"><meta name=application-name content="NetDevOps"><meta name=apple-mobile-web-app-title content="NetDevOps"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=192x192 href=/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=/android-chrome-512x512.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://netdevops.me/2020/arista-veos-gnmi-tutorial/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Arista vEOS gNMI Tutorial","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/netdevops.me\/2020\/arista-veos-gnmi-tutorial\/"},"genre":"posts","keywords":"gnmi, openconfig, arista, gnmic, yang","wordCount":1693,"url":"https:\/\/netdevops.me\/2020\/arista-veos-gnmi-tutorial\/","datePublished":"2020-07-25T07:00:00+00:00","dateModified":"2021-04-19T12:35:46+02:00","description":""}</script></head><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header><div class="desktop header" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=NetDevOps class="header-logo logo-svg">NetDevOps</a></div><div class=menu><nav><h2 class=display-hidden>–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è</h2><ul class=menu-inner><li><a class=menu-item href=/posts/>Posts</a></li><li><a class=menu-item href=/tags/>Tags</a></li></ul></nav><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=Search... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><span class="svg-icon icon-search"></span></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><span class="svg-icon icon-cancel"></span></a><span class="search-button search-loading" id=search-loading-desktop><span class="svg-icon icon-loading"></span></span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></div><div class="mobile header" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=NetDevOps class=header-logo>NetDevOps</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=Search... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><span class="svg-icon icon-search"></span></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><span class="svg-icon icon-cancel"></span></a><span class="search-button search-loading" id=search-loading-mobile><span class="svg-icon icon-loading"></span></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><nav><h2 class=display-hidden>–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è</h2><ul><li><a class=menu-item href=/posts/ title>Posts</a></li><li><a class=menu-item href=/tags/ title>Tags</a></li></ul></nav><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></div><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div></header><main class=main><div class="container content-article theme-classic"><div class=toc id=toc-auto><div class=toc-title>Contents</div><div class="toc-content always-active" id=toc-content-auto></div></div><article><header class=header-post><div class=post-title><div class=post-all-meta><nav class=breadcrumbs><ol><li><a href=/>Home</a></li><li>Arista vEOS gNMI Tutorial</li></ol></nav><h1 class="single-title flipInX">Arista vEOS gNMI Tutorial</h1><div class="post-meta summary-post-meta"><span class="post-meta-date meta-item"><span class="svg-icon icon-clock"></span><time class=timeago datetime=2020-07-25>2020-07-25</time>
</span><span class="post-meta-words meta-item"><span class="svg-icon icon-pencil"></span>1693 words</span>
<span class="post-meta-reading meta-item"><span class="svg-icon icon-stopwatch"></span>8 minutes</span></div></div></div></header><div class="article-post toc-start"><div class="content-block content-block-first content-block-position"><div class="post single"><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#veos-configuration>vEOS configuration</a></li><li><a href=#gnmi-capabilities>gNMI Capabilities</a></li><li><a href=#getting-to-know-arista-yang-models>Getting to know Arista YANG models</a></li><li><a href=#gnmi-get>gNMI Get</a><ul><li></li></ul></li><li><a href=#gnmi-set>gNMI Set</a><ul><li></li></ul></li><li><a href=#gnmi-subscribe>gNMI Subscribe</a><ul><li></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></div></div><div style="margin:20px 0"><span class=post-update><span class=s>Updated on 2021-04-19</span></span></div><p>We were pleasantly surprised by the way community appreciated <a href=https://netdevops.me/2020/gnmic-gnmi-cli-client-and-collector/ target=_blank rel="noopener noreffer">gNMIc</a> release. Thank you üôè! That solidifies the fact that a well-formed, documented and easy to use gNMI tool was needed.</p><p>Now with gNMIc available to everybody its easy like never before to test gNMI implementation of different routing OSes. And in this post we will get our hands on <strong>Arista vEOS</strong>.</p><p>For this journey we pack:</p><ol><li>vEOS router (either physical or virtual)</li><li>gNMIc <a href=https://gnmic.kmrd.dev/ target=_blank rel="noopener noreffer">documentation</a></li><li>and a <a href=https://github.com/hellt/gnmi-map target=_blank rel="noopener noreffer">gNMI-map</a> to navigate through the gNMI realm.</li></ol><p>Arista vEOS-for-labs is freely distributed and you can download the vmdk image from the official <a href=https://www.arista.com/en/support/software-download target=_blank rel="noopener noreffer">software portal</a>.</p><p><strong>Table of contents</strong></p><ol><li><a href=#veos-configuration rel>vEOS configuration</a></li><li><a href=#gnmi-capabilities rel>gNMI Capabilities</a></li><li><a href=#getting-to-know-arista-yang-models rel>Getting to know Arista YANG models</a></li><li><a href=#gnmi-get rel>gNMI Get</a></li><li><a href=#gnmi-set rel>gNMI Set</a></li><li><a href=#gnmi-subscribe rel>gNMI Subscribe</a></li><li><a href=#sample-subscriptions rel>Sample subscriptions</a></li><li><a href=#on-change-subscriptions rel>ON_CHANGE subcriptions</a></li></ol><h2 id=veos-configuration class=headerLink><a href=#veos-configuration class=header-mark></a>vEOS configuration</h2><p>Once your vEOS starts with a blank config (credentials: <code>admin</code> and an empty pass) we ought to add a minimal config to it before gNMI fun starts:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-txt data-lang=txt>username admin privilege 15 secret admin
!
interface Ethernet1
   no switchport
   ip address 10.2.0.21/24
!
management api gnmi
   transport grpc default
</code></pre></td></tr></table></div></div><p>With this config snippet we do a few things important from the gNMI standpoint:</p><ul><li>enabling password for <code>admin</code> to authenticate with a router</li><li>configuring IP address for the <code>Ethernet1</code> interface to let gNMIc reach the router</li><li>enabling <code>gnmi</code> management interface with the default transport config<ul><li>default transport doesn&rsquo;t enforce TLS usage and uses <code>6030</code> port</li></ul></li></ul><p>That is all it takes to configure vEOS to start replying to our first gNMI RPCs, ridiculously easy!</p><h2 id=gnmi-capabilities class=headerLink><a href=#gnmi-capabilities class=header-mark></a>gNMI Capabilities</h2><p>With gNMIc <a href=https://gnmic.kmrd.dev/install/ target=_blank rel="noopener noreffer">installed</a>, our first stop would be trying out the gNMI Capabilities RPC. The Capabilities RPC is quite instrumental as it uncovers which gNMI version the device runs, what models it is loaded with and which encoding it understands.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 6030 - the default gNMI port on vEOS</span>
<span class=c1># credentials are admin:admin</span>
<span class=c1># --insecure mode is used to not enforce the TLS transport</span>
$ gnmic -a 10.2.0.21:6030 -u admin -p admin --insecure capabilities
gNMI version: 0.7.0
supported models:
  - openconfig-rib-bgp, OpenConfig working group, 0.7.0
  - arista-qos-augments, Arista Networks, Inc., 
  - arista-srte-deviations, Arista Networks, Inc., 
  
&lt;CLIPPED&gt;

  - openconfig-platform-linecard, OpenConfig working group, 0.1.1
  - openconfig-if-tunnel, OpenConfig working group, 0.1.1
supported encodings:
  - JSON
  - JSON_IETF
  - ASCII
</code></pre></td></tr></table></div></div><p>Judging by the output returned we see that</p><ul><li>vEOS 4.24.1.1F in my lab runs the latest gNMI version 0.7.0</li><li>it is configured with both openconfig and native models</li><li>it supports two variants of JSON encoding with a useless ASCII</li></ul><h2 id=getting-to-know-arista-yang-models class=headerLink><a href=#getting-to-know-arista-yang-models class=header-mark></a>Getting to know Arista YANG models</h2><p>Before we can dive into the rest RPCs of gNMI service we have to get to know the YANG models vEOS listed as supported in Capabilities response.</p><p>Arista publishes its YANG models in the <a href=https://github.com/aristanetworks/yang target=_blank rel="noopener noreffer">aristanetworks/yang</a> repo and by the looks of it it seems they are OpenConfig believers. For the vEOS 4.24.1.1F release that I am running the <a href=https://github.com/aristanetworks/yang/tree/master/EOS-4.24.0F target=_blank rel="noopener noreffer">list of YANG</a> models is definitely angled towards OpenConfig models with native YANG models marked as experimental.</p><p>Browsing the source OC YANG files in this repo is one way to understand the structure of the models, or we can use <a href=https://github.com/hellt/pyang-docker target=_blank rel="noopener noreffer">pyang</a> or <a href=https://github.com/openconfig/goyang target=_blank rel="noopener noreffer">goyang</a> to generate a tree view. Michael Kashin shows <a href=https://github.com/networkop/acb-oc target=_blank rel="noopener noreffer">here</a> how to use goyang to quickly generate tree views of Arista models.</p><p>Once we know the structure of the OC YANG models vEOS is equipped with we can finally get to more advanced RPCs fetching, setting and subscribing.</p><blockquote><p>If YANG transformation topic is hard on you, ping me in comments and I will expand on this.</p></blockquote><h2 id=gnmi-get class=headerLink><a href=#gnmi-get class=header-mark></a>gNMI Get</h2><p>Now that we know which models our gear runs we can easily issue a gNMI Get RPC with <a href=https://gnmic.kmrd.dev/cmd/get/ target=_blank rel="noopener noreffer"><code>get</code></a> command. Lets pretend that we would like to know the configured IP addresses on the vEOS. All it takes is to carefully walk through the OC model to the right leaf:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ gnmic -a 10.2.0.21:6030 -u admin -p admin --insecure get \
        --path &#34;/interfaces/interface[name=*]/subinterfaces/subinterface[index=*]/ipv4/addresses/address/config/ip&#34;
{
  &#34;source&#34;: &#34;10.2.0.21:6030&#34;,
  &#34;time&#34;: &#34;1970-01-01T02:00:00+02:00&#34;,
  &#34;updates&#34;: [
    {
      &#34;Path&#34;: &#34;/interfaces/interface[name=Ethernet1]/subinterfaces/subinterface[index=0]/ipv4/addresses/address[ip=10.2.0.21]/config/ip&#34;,
      &#34;values&#34;: {
        &#34;interfaces/interface/subinterfaces/subinterface/ipv4/addresses/address/config/ip&#34;: &#34;10.2.0.21&#34;
      }
    }
  ]
}
</code></pre></td></tr></table></div></div><p>The returned output indicates that router has only one IPv4 address <code>10.2.0.21</code> configured and it is contained within the <code>/interfaces/interface[name=Ethernet1]/subinterfaces/subinterface[index=0]/ipv4/addresses/address[ip=10.2.0.21]/config/ip</code> path. The paths in its turn shows that the interfaces that has this IP is <code>Ethernet1</code>.</p><h4 id=gnmi-get-all class=headerLink><a href=#gnmi-get-all class=header-mark></a>gNMI Get ALL</h4><p>One particular trick that might come very handy is getting the entire config/state of the router with gNMI. That will likely output a lot of data but it will enable you to search through it and find the right path in the model for a more precise get/set/subscribe queries.</p><p>The trick is to specify the root <code>/</code> path for your Get RPC that will dump all the data from the router. Its better to redirect the output to a file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ gnmic -a 10.2.0.21:6030 -u admin -p admin --insecure get --path / &gt; /tmp/arista.all.json
</code></pre></td></tr></table></div></div><p><a href=https://gist.github.com/hellt/7f274d6ac65a88875e8eab1b5afef336 target=_blank rel="noopener noreffer">Here</a> is the resulting JSON that I fetched from my lab router. This way you can &ldquo;reverse engineer&rdquo; the models tree view by letting a router send you all its state and config.</p><h2 id=gnmi-set class=headerLink><a href=#gnmi-set class=header-mark></a>gNMI Set</h2><p>Our next RPC will change the configuration on a vEOS router. This is done with the gNMIc <a href=https://gnmic.kmrd.dev/cmd/set/ target=_blank rel="noopener noreffer"><code>set</code></a> command.</p><h4 id=updating-configuration class=headerLink><a href=#updating-configuration class=header-mark></a>Updating configuration</h4><p>A quick example would be to add a description to a port. But first lets ensure that its not set:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ gnmic -a 10.2.0.21:6030 -u admin -p admin --insecure get \
        --path &#34;/interfaces/interface[name=Ethernet1]/config/description&#34;
{
  &#34;source&#34;: &#34;10.2.0.21:6030&#34;,
  &#34;time&#34;: &#34;1970-01-01T02:00:00+02:00&#34;,
  &#34;updates&#34;: [
    {
      &#34;Path&#34;: &#34;/interfaces/interface[name=Ethernet1]/config/description&#34;,
      &#34;values&#34;: {
        &#34;interfaces/interface/config/description&#34;: &#34;&#34;
      }
    }
  ]
}
</code></pre></td></tr></table></div></div><p>All good, the description is empty, lets set it to <code>gnmic-example</code> value:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ gnmic -a 10.2.0.21:6030 -u admin -p admin --insecure set \
        --update-path &#34;/interfaces/interface[name=Ethernet1]/config/description&#34; \
        --update-value &#34;gnmic-example&#34;
{
  &#34;source&#34;: &#34;10.2.0.21:6030&#34;,
  &#34;timestamp&#34;: 1595749808169752510,
  &#34;time&#34;: &#34;2020-07-26T10:50:08.16975251+03:00&#34;,
  &#34;results&#34;: [
    {
      &#34;operation&#34;: &#34;UPDATE&#34;,
      &#34;path&#34;: &#34;/interfaces/interface[name=Ethernet1]/config/description&#34;
    }
  ]
}
</code></pre></td></tr></table></div></div><p>With the implicit-type kind of a set operation gNMIc will use the JSON encoding for the value specified with <code>--update-value</code> flag. The result we get back from the box confirms that the UPDATE operation has been applied. Now we can check if the value is indeed set by repeating the get command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ gnmic -a 10.2.0.21:6030 -u admin -p admin --insecure get \
--path &#34;/interfaces/interface[name=Ethernet1]/config/description&#34;
{
  &#34;source&#34;: &#34;10.2.0.21:6030&#34;,
  &#34;time&#34;: &#34;1970-01-01T02:00:00+02:00&#34;,
  &#34;updates&#34;: [
    {
      &#34;Path&#34;: &#34;/interfaces/interface[name=Ethernet1]/config/description&#34;,
      &#34;values&#34;: {
        &#34;interfaces/interface/config/description&#34;: &#34;gnmic-example&#34;
      }
    }
  ]
}
</code></pre></td></tr></table></div></div><p>Now we see the description set to the value we specified.</p><blockquote><p>gNMIc supports many ways to provide the configuration values, check <a href=https://gnmic.kmrd.dev/cmd/set/ target=_blank rel="noopener noreffer"><code>set</code></a> command docs for all the options.</p></blockquote><h4 id=deleting-configuration class=headerLink><a href=#deleting-configuration class=header-mark></a>Deleting configuration</h4><p>gNMI Set RPC allows not only to update/replace the configuration but also to delete it. Lets remove the description we set before with the <a href=https://gnmic.kmrd.dev/cmd/set/#delete target=_blank rel="noopener noreffer"><code>delete</code></a> flag of the set command.:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ gnmic -a 10.2.0.21:6030 -u admin -p admin --insecure set \
        --delete &#34;/interfaces/interface[name=Ethernet1]/config/description&#34;
{
  &#34;source&#34;: &#34;10.2.0.21:6030&#34;,
  &#34;timestamp&#34;: 1595750232015131720,
  &#34;time&#34;: &#34;2020-07-26T10:57:12.01513172+03:00&#34;,
  &#34;results&#34;: [
    {
      &#34;operation&#34;: &#34;DELETE&#34;,
      &#34;path&#34;: &#34;/interfaces/interface[name=Ethernet1]/config/description&#34;
    }
  ]
}
</code></pre></td></tr></table></div></div><h2 id=gnmi-subscribe class=headerLink><a href=#gnmi-subscribe class=header-mark></a>gNMI Subscribe</h2><p>And we managed to get to the end of it. The crown jewel of gNMI service - Subscribe RPC.</p><p>To demonstrate gNMI subscriptions done with the corresponding <a href=https://gnmic.kmrd.dev/cmd/subscribe/ target=_blank rel="noopener noreffer"><code>subscribe</code></a> command we will solve the following tasks:</p><ul><li>subscribe to interface counters and see the effect of SAMPLE subscriptions with different sampling intervals</li><li>subscribe to a protocol admin status and see the effect of ON_CHANGE mode of subscription</li></ul><p>The <a href=https://gnmic.kmrd.dev/cmd/subscribe/ target=_blank rel="noopener noreffer"><code>subscribe</code></a> command has a lot of options which are instrumental to tailor the command behavior to your needs.</p><h4 id=sample-subscriptions class=headerLink><a href=#sample-subscriptions class=header-mark></a>Sample subscriptions</h4><p>For the <a href=https://github.com/openconfig/reference/blob/master/rpc/gnmi/gnmi-specification.md#35152-stream-subscriptions target=_blank rel="noopener noreffer">sampled</a> subscriptions we expect to receive the value of the subscribed data node with each sampling interval; doesn&rsquo;t matter if the data changes in-between the sampling timestamps or not, we will get it with the cadence specified by the sample-interval.</p><p>Samples subscriptions are useful for rapidly changing data, like interface counters. Lets subscribe to our only interface <code>Ethernet1</code> with 2 seconds sampling interval.</p><blockquote><p>Note, we had to disable QoS marking by setting it to 0, since vEOS does not support marking for gNMI messages.</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>$ gnmic -a 10.2.0.21:6030 -u admin -p admin --insecure subscribe \
        --path &#34;/interfaces/interface[name=Ethernet1]/subinterfaces/subinterface/state/counters/in-octets&#34; \
        --stream-mode sample --sample-interval 2s \
        --qos 0
</code></pre></td></tr></table></div></div><blockquote><p><img loading=lazy decoding=async class=render-image src=https://gitlab.com/rdodin/pics/-/wikis/uploads/43e9b925c7d8f6ce1703b06e823971d3/CleanShot_2020-07-26_at_10.33.24.gif alt=sample title=CleanShot_2020-07-26_at_10.33.24.gif></p></blockquote><center><small>_sampled subscriptions arriving with 2s interval_</small></center><h4 id=on-change-subscriptions class=headerLink><a href=#on-change-subscriptions class=header-mark></a>On Change subscriptions</h4><p>The other popular subscription mode is ON_CHANGE where the router pushes the data towards the collector when the data changes. With such a mode you don&rsquo;t push the data unnecessarily.</p><p>A popular use case for ON_CHANGE subscriptions is to subscribe to oper/admin state of control plane protocols to get notified when the state changes (aka trap).</p><p>To demonstrate this behavior we will</p><ul><li>configure BGP process on vEOS</li><li>subscribe with ON_CHANGE mode to the BGP AS leaf effectively watching its value.</li></ul><p>Our trivial BGP configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>!
ip routing
!
router bgp 2
</code></pre></td></tr></table></div></div><p>Now lets subscribe to the AS number with:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>$ gnmic -a 10.2.0.21:6030 -u admin -p admin --insecure subscribe \
        --path &#34;/network-instances/network-instance[name=default]/protocols/protocol[identifier=BGP][name=BGP]/bgp/global/config/as&#34; \
        --stream-mode on_change \
        --qos 0

{
  &#34;source&#34;: &#34;10.2.0.21:6030&#34;,
  &#34;subscription-name&#34;: &#34;default&#34;,
  &#34;timestamp&#34;: 1595753683536455210,
  &#34;time&#34;: &#34;2020-07-26T11:54:43.53645521+03:00&#34;,
  &#34;updates&#34;: [
    {
      &#34;Path&#34;: &#34;network-instances/network-instance[name=default]/protocols/protocol[identifier=BGP][name=BGP]/bgp/global/config/as&#34;,
      &#34;values&#34;: {
        &#34;network-instances/network-instance/protocols/protocol/bgp/global/config/as&#34;: 2
      }
    }
  ]
}
</code></pre></td></tr></table></div></div><p>Our subscription will stand still, as the AS number doesn&rsquo;t change, the router will not update it, unless the value changes.</p><p>Lets remove the BGP process from the router and see what happens:</p><blockquote><p><img loading=lazy decoding=async class=render-image src=https://gitlab.com/rdodin/pics/-/wikis/uploads/4055ac6cf3cd588a0623e7ac8750b381/CleanShot_2020-07-26_at_10.58.52.gif alt=on_change title=CleanShot_2020-07-26_at_10.58.52.gif></p></blockquote><center><small>_on change subscriptions arrive when data changes_</small></center><p>Here we receive a notification update about the deletion of the data we subscribed to immediately when the deletion happens.</p><h2 id=summary class=headerLink><a href=#summary class=header-mark></a>Summary</h2><p>In this post we put <a href=https://gnmic.kmrd.dev/ target=_blank rel="noopener noreffer">gNMIc</a> to a good use against Arista vEOS. All of the gNMI service RPCs have been successfully tested against vEOS, we have identified which encoding vEOS supports, found out that it uses OpenConfig models mostly and it can&rsquo;t use QoS markings.</p><p>On the bright side, vEOS supports ON_CHANGE subscriptions and is capable of delivering subsecond updates.</p></div><footer><div class=post><div class=post-share><div class=share-link><a class="share-icon share-twitter" href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://netdevops.me/2020/arista-veos-gnmi-tutorial/ data-title="Arista vEOS gNMI Tutorial" data-via=ntdvps data-hashtags=gnmi,openconfig,arista,gnmic,yang><span class="svg-social-icon icon-twitter"></span></a></div><div class=share-link><a class="share-icon share-facebook" href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://netdevops.me/2020/arista-veos-gnmi-tutorial/ data-hashtag=gnmi><span class="svg-social-icon icon-facebook"></span></a></div><div class=share-link><a class="share-icon share-linkedin" href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://netdevops.me/2020/arista-veos-gnmi-tutorial/><span class="svg-social-icon icon-linkedin"></span></a></div></div><div class=post-tags><a href=/tags/gnmi/ class=tag>gnmi</a><a href=/tags/openconfig/ class=tag>openconfig</a><a href=/tags/arista/ class=tag>arista</a><a href=/tags/gnmic/ class=tag>gnmic</a><a href=/tags/yang/ class=tag>YANG</a></div></div></footer></div><div id=toc-final></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.82.0">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://netdevops.me/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target=_blank title="uBlogger 2.0.1">uBlogger</a></div><div class=footer-line><i class="svg-icon icon-copyright"></i><span>2015 - 2021</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><aside id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="svg-icon icon-arrow-up"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="svg-icon icon-comments-fixed"></i></a></aside><link rel=stylesheet href=/drawio.css><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/autocomplete/autocomplete.min.js></script><script src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script src=/lib/sharer/sharer.min.js></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:20},search:{algoliaAppID:"H1AI8QKFEK",algoliaIndex:"blog",algoliaSearchKey:"0544bc3c928ba0e387c3b3353112e43d",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:60,type:"algolia"}}</script><script src=/js/theme.min.js></script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-101537614-1','auto'),ga('send','pageview')</script></body></html>